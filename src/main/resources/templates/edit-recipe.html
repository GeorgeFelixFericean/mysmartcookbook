<!DOCTYPE html>
<html lang="ro">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>EditeazƒÉ Re»õetƒÉ</title>
        <link rel="icon" type="image/png" href="/img/favicon.png">
        <link rel="stylesheet" href="/css/styles.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <style>
            body.edit-recipe-page {
              height: 100vh;
              overflow: hidden;
            }

            .edit-recipe-wrapper {
              height: calc(100vh - 56px - 50px);
              display: flex;
              justify-content: center;
              align-items: center;
              padding: 20px;
            }

            .edit-recipe-container {
              background-color: rgba(255, 255, 255, 0.95);
              border-radius: 12px;
              max-width: 650px;
              width: 100%;
              padding: 25px 30px;
              overflow-y: auto;
              max-height: calc(90vh - 50px);
              box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
              animation: fadeInForm 0.5s ease-out forwards;
              scrollbar-width: none;
            }

            .edit-recipe-container::-webkit-scrollbar {
              display: none;
            }

            .edit-recipe-container input,
            .edit-recipe-container textarea,
            .edit-recipe-container label {
              margin-bottom: 3px;
            }

            .home-button-container {
              position: absolute;
              top: 70px;
              left: 20px;
              z-index: 10;
            }

            #imagePreview {
              display: block;
              max-width: 100%;
              max-height: 250px;
              margin-bottom: 10px;
              border-radius: 5px;
            }

            @keyframes fadeInForm {
              from {
                opacity: 0;
                transform: translateY(-10px);
              }

              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
        </style>
    </head>
    <body class="edit-recipe-page">
        <!-- Navbar responsive cu iconi»õe »ôi text pe mobil -->
        <!-- Navbar va fi injectat aici -->
        <div id="navbar-placeholder"></div>
        <div class="home-button-container">
            <a href="/home" class="btn btn-primary px-4 py-2 fw-semibold shadow rounded-pill"> ‚Üê Take Me Home, Chef! </a>
        </div>
        <div class="edit-recipe-wrapper">
            <div class="edit-recipe-container scaled-form">
                <h2 class="text-center mb-4">üç¥ Tweak Your Tasty Creation</h2>
                <form id="editRecipeForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">üè∑Ô∏è Give it a name worthy of a feast
                            <span class="text-muted small">(Keep it snappy ‚Äî 60 characters max!)</span>
                        </label>
                        <input type="text" class="form-control" id="name" maxlength="60">
                    </div>
                    <div class="mb-3">
                        <label for="instructions" class="form-label">‚ú® How does the magic happen?</label>
                        <textarea class="form-control" id="instructions" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">üí° Tips, swaps, or secrets?</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="externalLink" class="form-label">üìé Found this gem online?</label>
                        <input type="url" class="form-control" id="externalLink" placeholder="https://...">
                    </div>
                    <div class="mb-3">
                        <label for="imageFile" class="form-label d-block">üì∑ Got a better food glam? Upload it!</label>
                        <!-- Butonul de upload stilizat -->
                        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('imageFile').click()"> üìÅ Pick your glam shot! </button>
                        <!-- Inputul real, ascuns -->
                        <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;" />
                        <!-- Textul care apare c√¢nd nu e imagine -->
                        <div id="fileStatusText" class="text-muted small fst-italic mt-1"> Still waiting for a <span class="fst-italic">masterpiece</span>... </div>
                        <!-- Preview imagine -->
                        <div id="imagePreview" class="mt-3"></div>
                    </div>
                    <h5>ü•Ñ The tasty components!</h5>
                    <div id="ingredientsContainer"></div>
                    <button type="button" class="btn btn-secondary mb-3" onclick="addIngredientField()">‚ûï Toss in another one!</button>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning w-100">üíæ Save the delicious upgrade</button>
                        <a id="cancelButton" class="btn btn-outline-secondary w-100">‚ùå Never mind, go back!</a>
                    </div>
                </form>
                <!-- Error message for oversized images or other form issues -->
                <div id="errorMessage" class="text-danger text-center fw-semibold mt-2" style="display: none;"></div>
            </div>
        </div>
        <!-- üîî Toast pentru mesaje de eroare -->
        <div id="toastMessage" class="toast-message"></div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/scripts.js"></script>
        <script>
            const recipeId = window.location.pathname.split("/").pop();

            document.addEventListener("DOMContentLoaded", () => {
                fetch(`/api/recipes/${recipeId}`)
                    .then(res => res.json())
                    .then(recipe => {
                        document.getElementById("name").value = recipe.name || "";
                        document.getElementById("instructions").value = recipe.instructions || "";
                        document.getElementById("notes").value = recipe.notes || "";
                        document.getElementById("externalLink").value = recipe.externalLink || "";
                        if (recipe.imagePath) {
                            const img = document.getElementById("imagePreview");
                            img.src = recipe.imagePath;
                            img.style.display = "block";
                        }

                        document.getElementById("cancelButton").href = `/recipe/${recipeId}`;

                        recipe.ingredients.forEach(ingredient => {
                            addIngredientField(ingredient.name, ingredient.quantity, ingredient.unit);
                        });
                    });
            });

            function addIngredientField(name = "", quantity = "", unit = "") {
                const container = document.getElementById("ingredientsContainer");
                const html = `
                    <div class="row mb-2 ingredient-row align-items-center">
                        <div class="col-md-4 col-12 mb-2 mb-md-0">
                            <input type="text" class="form-control" name="ingredientName" placeholder="Ingredient" value="${name}">
                        </div>
                        <div class="col-md-3 col-6 mb-2 mb-md-0">
                            <input type="number" step="any" class="form-control" name="ingredientQuantity" placeholder="Qty" value="${quantity}">
                        </div>
                        <div class="col-md-3 col-6 mb-2 mb-md-0">
                            <select class="form-select" name="ingredientUnit">
                                <option value="GRAM" ${unit === "GRAM" ? "selected" : ""}>g</option>
                                <option value="KILOGRAM" ${unit === "KILOGRAM" ? "selected" : ""}>kg</option>
                                <option value="MILLILITER" ${unit === "MILLILITER" ? "selected" : ""}>ml</option>
                                <option value="LITER" ${unit === "LITER" ? "selected" : ""}>l</option>
                                <option value="CUP" ${unit === "CUP" ? "selected" : ""}>cup</option>
                                <option value="TABLESPOON" ${unit === "TABLESPOON" ? "selected" : ""}>tbsp</option>
                                <option value="TEASPOON" ${unit === "TEASPOON" ? "selected" : ""}>tsp</option>
                                <option value="PIECE" ${unit === "PIECE" ? "selected" : ""}>pcs</option>
                            </select>
                        </div>
                        <div class="col-md-2 col-12 text-md-end">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100 w-md-auto mt-2 mt-md-0" onclick="this.closest('.ingredient-row').remove()">
                                üóëÔ∏è Toss it out!
                            </button>
                        </div>
                    </div>`;


                container.insertAdjacentHTML("beforeend", html);
            }

            document.getElementById("editRecipeForm").addEventListener("submit", function(event) {
                event.preventDefault();

                const formData = new FormData();
                const name = document.getElementById("name").value.trim();
                if (!name) {
                    console.log("‚ö†Ô∏è Triggered empty name validation");
                    showToast("‚ö†Ô∏è Don't leave your masterpiece nameless!", false);
                    return;
                }
                const recipeDTO = {
                    name: document.getElementById("name").value,
                    instructions: document.getElementById("instructions").value,
                    notes: document.getElementById("notes").value,
                    externalLink: document.getElementById("externalLink").value,
                    ingredients: []
                };

                const names = document.getElementsByName("ingredientName");
                const quantities = document.getElementsByName("ingredientQuantity");
                const units = document.getElementsByName("ingredientUnit");

                for (let i = 0; i < names.length; i++) {
                    if (names[i].value.trim()) {
                        recipeDTO.ingredients.push({
                            name: names[i].value,
                            quantity: parseFloat(quantities[i].value),
                            unit: units[i].value
                        });
                    }
                }

                formData.append("recipeDTO", new Blob([JSON.stringify(recipeDTO)], { type: "application/json" }));

                const imageFile = document.getElementById("imageFile").files[0];

                if (imageFile) {
                    const maxSize = 1 * 1024 * 1024; // 5MB
                    if (imageFile.size > maxSize) {
                        const errorElement = document.getElementById("errorMessage"); // adaugƒÉ div-ul dacƒÉ nu-l ai deja
                        errorElement.textContent = "üì∏ That file‚Äôs too fabulous to fit! Max size is 5MB.";
                        errorElement.style.display = "block";
                        return; // opre»ôte submitul
                    }

                    formData.append("imageFile", imageFile);
                }


                fetch(`/api/recipes/${recipeId}`, {
                    method: "PUT",
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error("Eroare la salvarea modificƒÉrilor.");
                    window.location.href = `/recipe/${recipeId}`;
                })
                .catch(error => alert(error.message));
            });
        </script>
        <!-- Injectare navbar -->
        <script>
            fetch("/html/navbar.html")
              .then(response => response.text())
              .then(html => {
                const container = document.getElementById("navbar-placeholder");
                container.innerHTML = html;

                // üîπ ActiveazƒÉ tooltip-urile Bootstrap doar pentru elementele din navbar
                const tooltips = container.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltips.forEach(el => new bootstrap.Tooltip(el));

                // üîπ SeteazƒÉ username-ul din localStorage √Æn navbar
                const username = localStorage.getItem("loggedUser");
                const nameSpan = document.getElementById("navbarUsername");
                if (username && nameSpan) {
                  nameSpan.textContent = username;
                }

                // üîπ Func»õie globalƒÉ pentru logout
                window.logoutUser = function () {
                  console.log("Logout button clicked");

                  localStorage.removeItem("loggedUser");

                  fetch('/api/users/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                  })
                  .then(response => {
                    console.log("Logout request completed:", response.status);
                    window.location.href = "/";
                  })
                  .catch(error => {
                    console.error("Logout request failed:", error);
                    window.location.href = "/";
                  });
                };

                // ‚úÖ Ata»ôare eveniment dupƒÉ ce navbar-ul este injectat
                const logoutButton = document.getElementById("logoutButton");
                if (logoutButton) {
                  console.log("Logout button found after navbar injection");
                  logoutButton.addEventListener("click", window.logoutUser);
                } else {
                  console.log("Logout button not found after navbar injection");
                }
              })
              .catch(error => {
                console.error("Failed to load navbar:", error);
              });
        </script>
    </body>
</html>